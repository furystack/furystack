variables:
  - group: Default Variable Group

trigger:
  - master
  - develop
  - feature/*
  - release/*

pool:
  vmImage: 'ubuntu-latest'

jobs:
  - job: buildAndTest
    displayName: Build and test
    steps:
      - checkout: self
        fetchDepth: 1
      - task: DockerCompose@0
        displayName: Start services from docker-compose
        inputs:
          action: Run services
          detached: true
          buildImages: true
      - task: NodeTool@0
        inputs:
          versionSpec: '18.x'
        displayName: 'Install Node.js'

      - script: yarn install --immutable
        displayName: 'Install'

      - script: yarn lint
        displayName: 'Lint'

      - script: yarn build
        displayName: 'Build'

      - script: yarn create-schemas
        displayName: Recreate JSON Schemas

      - script: yarn test --coverage
        env:
          CI: true
        displayName: 'Test'

      # - script: bash <(curl -s https://codecov.io/bash)
      #   displayName: 'Publish test results to Codecov'

      - task: PublishCodeCoverageResults@1
        displayName: 'Publish test coverage results'
        inputs:
          codeCoverageTool: Cobertura
          summaryFileLocation: '$(System.DefaultWorkingDirectory)/packages/**/coverage/*coverage.xml'
          reportDirectory: '$(System.DefaultWorkingDirectory)/packages/**/coverage'

      - task: PublishTestResults@2
        displayName: Publish test results
        condition: succeededOrFailed()
        inputs:
          testRunner: JUnit
          testResultsFiles: '$(System.DefaultWorkingDirectory)/coverage/junit.xml'


            
            